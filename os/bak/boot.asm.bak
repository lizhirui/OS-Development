[BITS 16]
	PARTITION_TABLE EQU 01BEH
	PARTITION_TABLE_RELATIVESECTORS EQU 08H
	MBR_BOOT_ADDR EQU 7C00H
	MBR_MEMORY_BOOT_ADDR EQU 0600H
	DBR_BOOT_ADDR EQU 7C00H
	DISKADDRESSPACKET_BLOCKCOUNT EQU 02H
	DISKADDRESSPACKET_BUFFERADDR EQU 04H
	DISKADDRESSPACKET_BLOCKNUM EQU 08H
	DRIVEPARAMETERSPACKET_CYLINDERS EQU 04H
	DRIVEPARAMETERSPACKET_HEADS EQU 08H
	DRIVEPARAMETERSPACKET_SECTORSPERTRACK EQU 0CH
	DRIVEPARAMETERSPACKET_SECTORS EQU 10H
	DRIVEPARAMETERSPACKET_SECTORSIZE EQU 18H
	ORG MBR_MEMORY_BOOT_ADDR
	MOV AX,CS
	MOV DS,AX
	MOV ES,AX
	MOV SS,AX
	MOV SP,00H
	CALL NEXT	;读取IP
NEXT:
	POP AX
	MOV SP,00H
	CMP AX,MBR_BOOT_ADDR
	JB START
	CLD
	MOV AX,0000H
	MOV DS,AX
	MOV ES,AX   ;将自身复制到内存0x00000600处
	MOV SI,MBR_BOOT_ADDR
	MOV DI,MBR_MEMORY_BOOT_ADDR
	MOV CX,0100H
	REP MOVSW
	JMP 0000:MBR_MEMORY_BOOT_ADDR
START:
	MOV CX,0
	
	;检查INT13H扩展功能是否存在
	MOV AH,41H
	MOV BX,55AAH
	MOV DL,0
	INT 13H
	CMP BX,0AA55H
	JMP $
	JNZ BOOT_PARTITION_FIND_LOOP
	MOV AX,EXTENSIONINT13ERROR
	CALL DISPSTR
	JMP $
BOOT_PARTITION_FIND_LOOP:    ;寻找引导扇区并寻找正确的DBR
	MOV AX,CX
	MOV DL,16
	MUL DL
	MOV DI,AX
	MOV BX,[DI+MBR_MEMORY_BOOT_ADDR+PARTITION_TABLE]
	CMP BL,80H
	JNZ BOOT_PARTITION_FIND_LOOP_NEXT
	PUSH CX
	MOV BX,DI
	CALL CHECKDBR
	POP CX
	CMP BX,01H		;寻找到引导分区
	JNZ BOOT_PARTITION_FIND_LOOP_NEXT
	JMP 0000:DBR_BOOT_ADDR
BOOT_PARTITION_FIND_LOOP_NEXT:
	INC CX
	CMP CX,4
	JNZ BOOT_PARTITION_FIND_LOOP
	MOV AX,DBRFINDERRMESSAGE   ;找不到DBR，报错
	CALL DISPSTR
	JMP $
CHECKDBR:
	;输入：BX - 分区表项基址
	;输出：BX - 返回值 0-失败 1-成功 
	MOV DI,DISKADDRESSPACKET
	MOV WORD [DI+DISKADDRESSPACKET_BLOCKCOUNT],0001H
	MOV EAX,[BX+MBR_MEMORY_BOOT_ADDR+PARTITION_TABLE+PARTITION_TABLE_RELATIVESECTORS]
	MOV DWORD [DI+DISKADDRESSPACKET_BLOCKNUM],EAX
	MOV WORD [DI+DISKADDRESSPACKET_BUFFERADDR],7C00H
	MOV WORD [DI+DISKADDRESSPACKET_BUFFERADDR+2],0000H
	MOV DWORD [DI+DISKADDRESSPACKET_BLOCKNUM+4],00000000H
	MOV AH,42H
	MOV DL,00H
	INT 13H
	JMP $
	MOV BX,00H
	RET
DISPSTR:
	;输入：AX - 字符串基址 ES:BP指向要显示的字符串
	
	MOV BP,AX
	MOV DI,0
LEN_FIND_LOOP:
	MOV AL,[ES:BP+DI]
	INC DI
	CMP AL,00H
	JNZ LEN_FIND_LOOP
	DEC DI
	MOV CX,DI
	MOV CH,00H
	MOV AX,01301h
	MOV BX,000ch
	MOV DL,0
	INT 10H
	RET
BOOTMESSAGE:     DB "Hello,OS world!",00H
DBRFINDERRMESSAGE DB "Can't Find Correct DBR!",00H
EXTENSIONINT13ERROR DB "BIOS Don't Support Extension INT13!",00H
DISKADDRESSPACKET DB 10H,00H,01H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H
DRIVEPARAMETERSPACKET DB 1AH,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H
TIMES 510-($-$$) DB 0
DW 0AA55H